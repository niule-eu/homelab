import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.2.1#/K8sResource.pkl"
import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.2.1#/api/apps/v1/Deployment.pkl"
import "configmaps/envoy-configs.pkl" as envoyconfigs
import "configmaps/envoy-secrets.pkl" as envoysecrets

hidden envoy_configs = envoyconfigs.resources
hidden envoy_secrets = envoysecrets.resources
hidden envoy_container_image : String = "docker.io/envoyproxy/envoy"
hidden envoy_container_image_tag : String = "distroless-v1.36-latest"

resources: Listing<K8sResource> = new {
  ...envoy_configs
  ...envoy_secrets
  new Deployment {
    metadata {
      name = "envoy"
    }
    spec {
      replicas = 1
      selector {
        matchLabels {
          ["app"] = "envoy"
        }
      }
      strategy {
        type = "Recreate"
      }
      template {
        metadata {
          labels {
            ["app"] = "envoy"
          }
        }
        spec {
          containers {
            new {
              name = "envoy"
              image = "\(envoy_container_image):\(envoy_container_image_tag)"
              securityContext {
                capabilities {
                  add {
                    "CAP_NET_ADMIN"
                    "CAP_NET_BIND_SERVICE"
                  }
                }
              }
              volumeMounts {
                new {
                  mountPath = "/etc/envoy/envoy.yaml:Z"
                  name = "envoy-configs"
                  subPath = "envoy.yaml"
                  readOnly = true
                }
                new {
                  mountPath = "/etc/envoy/secrets/:Z"
                  name = "envoy-secrets"
                  readOnly = true
                }
              }
            }
          }
          volumes {
            new {
              name = "envoy-configs"
              configMap {
                name = "envoy-configs"
              }
            }
            new {
              name = "envoy-secrets"
              secret {
                secretName = "envoy-secrets"
              }
            }
          }
        }
      }
    }
  }
}

output {
  value = resources
  renderer = (K8sResource.output.renderer as YamlRenderer) {
    isStream = true
  }
}