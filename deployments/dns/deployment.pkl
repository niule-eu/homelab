import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.2.1#/K8sResource.pkl"
import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.2.1#/api/apps/v1/Deployment.pkl"
import "configmaps/pdns-sqlite3-schema.pkl" as pdnssqlite3schema
import "configmaps/pdns-config.pkl" as pdnsconfig
import "configmaps/pdns-env.pkl" as pdnsenv
import "configmaps/coredns-config.pkl" as corednsconfig

hidden config_maps =
  let (pdns_config = (pdnsconfig.resources.toList()))
  let (pdns_env = (pdnsenv.resources.toList()))
  let (pdns_sqlite3_schema = (pdnssqlite3schema.resources.toList()))
  let (coredns_config = (corednsconfig.resources.toList()))
    (pdns_config + pdns_sqlite3_schema + coredns_config + pdns_env).toListing()

resources: Listing<K8sResource> = (config_maps) {
  new Deployment {
    metadata {
      name = "dns"
    }
    spec {
      replicas = 1
      selector {
        matchLabels {
          ["app"] = "dns"
        }
      }
      strategy {
        type = "Recreate"
      }
      template {
        metadata {
          labels {
            ["app"] = "dns"
          }
        }
        spec {
          initContainers {
            new {
              name = "corefile-template"
              image = "docker.io/hairyhenderson/gomplate:stable"
              env {
                new {
                  name = "POD_NAME"                  
                  valueFrom {
                    fieldRef {
                      fieldPath = "metadata.name"
                    }
                  }                  
                }
              }
              args {
                "-f"
                "/tmp/zones.gompl"
                "-d"
                "zones=file:///tmp/zones.yaml"
                "-o"
                "/etc/coredns/Corefile.d/fwd_zones"
              }
              volumeMounts {
                new {
                  mountPath = "/tmp/zones.yaml:Z"
                  name = "coredns-config"
                  subPath = "zones.yaml"
                }
                new {
                  mountPath = "/tmp/zones.gompl:Z"
                  name = "coredns-config"
                  subPath = "zones.gompl"
                }
                new {
                  mountPath = "/etc/coredns/Corefile.d/:Z"
                  name = "coredns-config-d"
                }
              }
            } 
            new {
              name = "sqlite3-init"
              image = "docker.io/powerdns/pdns-auth-master:latest"
              command {
                "sqlite3"
              }
              args {
                "-init"
                "/tmp/schema.sql"
                "/var/lib/powerdns/pdns.sqlite3"
              }
              volumeMounts {
                new {
                  mountPath = "/var/lib/powerdns/:Z"
                  name = "pdns-sqlite3"
                }
                new {
                  mountPath = "/tmp/schema.sql:Z"
                  name = "pdns-sqlite3-schema"
                  subPath = "schema.sql"
                }
              }
            }
          }
          containers {
            new {
              name = "pdns-auth"
              image = "docker.io/powerdns/pdns-auth-master:latest"
              ports {
                new {
                  containerPort = 8081
                  hostIP = "10.255.255.1"
                  hostPort = 8081
                  protocol = "TCP"
                }
              }
              envFrom {
                new {
                  configMapRef {
                    name = "pdns-env"
                    optional = false
                  }
                }
              }
              volumeMounts {
                new {
                  mountPath = "/var/lib/powerdns/:Z"
                  name = "pdns-sqlite3"
                }
                new {
                  mountPath = "/etc/powerdns/pdns.d/local-port.conf:Z"
                  name = "pdns-config"
                  subPath = "local-port.conf"
                }
              }
            }
            new {
              name = "coredns-fwdr"
              image = "docker.io/coredns/coredns:latest"
              args {
                "-conf"
                "/etc/coredns/Corefile"
                "-dns.port"
                "5301"
              }
              ports {
                new {
                  hostIP = "10.255.255.1"
                  hostPort = 5301
                  containerPort = 5301
                  protocol = "TCP"
                }
                new {
                  hostIP = "10.255.255.1"
                  hostPort = 5301
                  containerPort = 5301
                  protocol = "UDP"
                }
              }
              volumeMounts {
                new {
                  mountPath = "/etc/coredns/Corefile:Z"
                  name = "coredns-config"
                  subPath = "Corefile"
                }
                new {
                  mountPath = "/etc/coredns/Corefile.d/:Z"
                  name = "coredns-config-d"
                }
              }
            }
          }
          volumes {
            new {
              name = "pdns-sqlite3"
              persistentVolumeClaim {
                claimName = "pdns-sqlite3"
              }
            }
            new {
              name = "pdns-sqlite3-schema"
              configMap {
                name = "pdns-sqlite3-schema"
              }
            }
            new {
              name = "pdns-config"
              configMap {
                name = "pdns-config"
              }
            }
            new {
              name = "coredns-config"
              configMap {
                name = "coredns-config"
              }
            }
            new {
              name = "coredns-config-d"
              persistentVolumeClaim {
                claimName = "coredns-config-d"
              }
            }
          }
        }
      }
    }
  }
}

output {
  value = resources
  renderer = (K8sResource.output.renderer as YamlRenderer) {
    isStream = true
  }
}