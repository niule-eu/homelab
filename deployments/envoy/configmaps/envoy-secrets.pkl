import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.2.1#/K8sResource.pkl"
import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.2.1#/api/core/v1/Secret.pkl"

hidden envoy_secrets : Mapping<String, String>?

class EnvoySecrets {
  hidden envoy_secrets : Mapping<String, String>

  local encoded = envoy_secrets.toMap().mapValues((k : String, v : String) -> v.base64).toMapping()

  resources: Listing<K8sResource> = new Listing {
    new Secret {
      metadata {
        name = "envoy-secrets"
      }
      data {
        ...encoded
      }
    }
  }
}

resources: Listing<K8sResource> = (new EnvoySecrets { envoy_secrets = module.envoy_secrets ?? new Mapping {} }).resources

output {
  value = resources
  renderer = (K8sResource.output.renderer as YamlRenderer) {
    isStream = true
  }
}
