amends "../default/default.pkl"

import "pkl:reflect"

local module_path : String = reflect.Module(module).uri.drop(7)
local module_dir : String = (module_path.dropLastWhile((c : String) -> c != "/"))

hostname = "m720q"
disable_stub_listener = true
nm_no_auto_default = new {"eno1"}

storage {
  files {
    ["/etc/NetworkManager/system-connections/eno1.nmconnection"] {
      path = "/etc/NetworkManager/system-connections/eno1.nmconnection"
      mode {
        value = "0o600"
      }
      contents {
        inline = read(path.drop(1)).text
      }
    }
    for (algo in List("rsa", "ed25519", "ecdsa")) {
      ["/etc/ssh/ssh_host_\(algo)_key.pub"] {
        path = "/etc/ssh/ssh_host_\(algo)_key.pub"
        mode {
          value = "0o600"
        }
        contents {
          inline = read(path.drop(1)).text
        }
      }
      ["/etc/ssh/ssh_host_\(algo)_key"] {
        path = "/etc/ssh/ssh_host_\(algo)_key"
        mode {
          value = "0o600"
        }
        contents {
          inline = read("sopsblob:\(module_dir)etc/ssh/ssh_host_\(algo)_key").text
        }
      } 
    }
  }
}